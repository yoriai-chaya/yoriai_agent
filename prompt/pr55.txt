

[Question]
Next.js, TailwindCSS, Shadcn/ui, TypeScriptã‚’ç”¨ã„ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®ç¾çŠ¶ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚µãƒ¼ãƒã‹ã‚‰Streamingã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã€
ãã®ãƒ‡ãƒ¼ã‚¿ã‚’çŠ¶æ…‹å¤‰æ•°ã«æ ¼ç´ã—ã¦ãŠãã€ãã®æƒ…å ±ã‚’ã‚‚ã¨ã«é©å®œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
ã™ã‚‹å‡¦ç†ã‚’è¡Œã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚

## æŒ‡ç¤ºäº‹é …
ä¸‹è¨˜æ¡ä»¶ã«åŸºã¥ãã€ç¾çŠ¶ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¿®æ­£æ¡ˆï¼ˆQA.tsxã®ã‚³ãƒ¡ãƒ³ãƒˆè¨˜è¼‰éƒ¨ã‚’
å®Œæˆã•ã›ã‚‹ï¼‰ã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚

## æ¡ä»¶
case "started"ã®éš›ã«ã€ResponseEventå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€ã“ã‚Œã‚’
setResponseInfo()ã‚’ç”¨ã„ã¦çŠ¶æ…‹å¤‰æ•°responseInfoã«ä¿å­˜ã™ã‚‹ã€‚
ä½œæˆã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€
- s_res: StreamResponseå‹ã®event="started"ã®payloadã‚‚å«ã‚ã¦æ ¼ç´
- r_time: Streamãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ã®æ—¥æ™‚ã‚’æ ¼ç´

åŒæ§˜ã«ã€case "code"ã®éš›ã«ã‚‚ã€ResponseEventå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€
setResponseInfo()ã‚’ç”¨ã„ã¦çŠ¶æ…‹å¤‰æ•°responseInfoã«ä¿å­˜ã™ã‚‹ã€‚
ä½œæˆã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€
- s_res: StreamResponseå‹ã®event="code"ã®payloadã‚‚å«ã‚ã¦æ ¼ç´
- r_time: Streamãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ã®æ—¥æ™‚ã‚’æ ¼ç´

ãã—ã¦ã€
          <div className="col-span-3 text-sm">
            {/* ã“ã“ã«ä¸Šè¨˜æ¡ä»¶ã«åŸºã¥ãå‡¦ç†ã‚’è¨˜è¿°ã—ãŸã„ */}
          </div>
ã“ã®éƒ¨åˆ†ã«ã€case "started"ã®éš›ã«è¨­å®šã—ãŸresponseInfoã®æƒ…å ±ã‚’ä½¿ã£ã¦ã€
r_timeã®å€¤ã‚’è¡¨ç¤ºã•ã›ã‚‹å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹ã€‚

## ç¾çŠ¶ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
[types.ts] ï¼ˆå‹å®šç¾©ï¼‰
export type ChatStep = { status: "Unloaded" | "Loaded" | "Sended" };
export type State = { steps: ChatStep[] };
export type Action =
  | { type: "LOAD_FILE"; index: number }
  | { type: "SEND_PROMPT"; index: number };
export type FileInfo = {
  filename: string;
  content: string;
  mtime: Date;
};
export type PromptRequest = {
  prompt: string;
};
export type PromptResponse = {
  prompt: string;
};

export type StreamResponse =
  | { event: "code"; payload: { language: string; code: string } }
  | { event: "agent_update"; payload: { agent_name: string } }
  | { event: "delta"; payload: { text: string } }
  | { event: "started"; payload: { message: string } }
  | { event: "done"; payload: { message: string } };

export type ResponseEvent = {
  s_res: StreamResponse;
  r_time: Date;
};

export type ResponseInfo = {
  r_event: ResponseEvent[];
};

[page.tsx] ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
"use client";
import { useEffect, useReducer, useState, useRef } from "react";
import { Separator } from "@/components/ui/separator";
import { ScrollArea } from "@/components/ui/scroll-area";
import FileUploader from "./FileUploader";
import QA from "./QA";
import ShowPrompt from "./ShowPrompt";
import ShowResponse from "./ShowResponse";
import { State, FileInfo, ResponseInfo } from "./types";
import { reducer } from "./reducer";

const initialState: State = {
  steps: [{ status: "Unloaded" }],
};
const initialFileInfo: FileInfo[] = [
  { filename: "", content: "", mtime: new Date(0) },
];
const initialResponseInfo: ResponseInfo[] = [];

export default function App() {
  const [state, dispatch] = useReducer(reducer, initialState);
  const [fileInfo, setFileInfo] = useState<FileInfo[]>(initialFileInfo);
  const [responseInfo, setResponseInfo] =
    useState<ResponseInfo[]>(initialResponseInfo);
  useEffect(() => {
    console.log("fileInfo updated: ", fileInfo);
    scrollRightPanel();
  }, [fileInfo]);
  useEffect(() => {
    console.log("state updated: ", state);
    scrollLeftPanel();
  }, [state]);
  useEffect(() => {
    console.log("responseInfo updated: ", responseInfo);
    scrollRightPanel();
  }, [responseInfo]);

  const rightPanel = useRef<HTMLDivElement>(null);
  const leftPanel = useRef<HTMLDivElement>(null);

  const scrollRightPanel = () => {
    if (rightPanel.current) {
      rightPanel.current.scrollIntoView({
        behavior: "smooth",
        block: "end",
      });
    }
  };
  const scrollLeftPanel = () => {
    if (leftPanel.current) {
      leftPanel.current.scrollIntoView({
        behavior: "smooth",
        block: "end",
      });
    }
  };

  if (fileInfo.length < state.steps.length) {
    setFileInfo((prev) => [
      ...prev,
      { filename: "", content: "", mtime: new Date(0) },
    ]);
  }

  return (
    <div className="flex h-screen">
      {/* Left-Panel */}
      <ScrollArea className="w-1/2 p-4Â border-r space-y-4">
        <div ref={leftPanel}>
          {state.steps.map((step, index) => (
            <div key={index}>
              <p className="text-xl my-2">
                Step {index} - Status: {step.status}
              </p>
              <FileUploader
                index={index}
                status={step.status}
                dispatch={dispatch}
                setFileInfo={setFileInfo}
              />
              <QA
                index={index}
                status={step.status}
                dispatch={dispatch}
                fileInfo={fileInfo[index]}
                setResponseInfo={setResponseInfo}
                responseInfo={responseInfo[index]}
              />
              <Separator />
            </div>
          ))}
        </div>
      </ScrollArea>
      {/* Right-Panel */}
      <ScrollArea className="w-1/2 p-4Â border-r space-y-4">
        <div ref={rightPanel}>
          {state.steps.map((step, index) => (
            <div key={index}>
              <p className="text-xl my-2">
                Step {index} - Status: {step.status}
              </p>
              <ShowPrompt
                index={index}
                status={step.status}
                fileInfo={fileInfo}
              />
              <ShowResponse
                index={index}
                status={step.status}
                responseInfo={responseInfo}
              />
            </div>
          ))}
        </div>
      </ScrollArea>
    </div>
  );
}

[QA.tsx] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¨ã®é€šä¿¡åŠã³çµæœã‚’çŠ¶æ…‹å¤‰æ•°ã«æ ¼ç´ã€ç”»é¢è¡¨ç¤º
"use client";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Button } from "@/components/ui/button";
import { Send } from "lucide-react";
import { Action, FileInfo, PromptRequest } from "./types";
import { ResponseInfo, StreamResponse } from "./types";

interface QAProps {
  status: string;
  index: number;
  dispatch: React.Dispatch<Action>;
  fileInfo: FileInfo;
  setResponseInfo: React.Dispatch<React.SetStateAction<ResponseInfo[]>>;
  responseInfo: ResponseInfo;
}

const QA = ({
  status,
  index,
  dispatch,
  fileInfo,
  setResponseInfo,
  responseInfo,
}: QAProps) => {
  const sendPrompt = async () => {
    console.log("sendPrompt called");
    const requestBody: PromptRequest = { prompt: fileInfo.content };
    try {
      const response = await fetch("http://localhost:8000/main", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestBody),
      });
      if (!response.body) {
        console.log("fetch response error");
        return;
      }
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let partial = "";

      dispatch({ type: "SEND_PROMPT", index });

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        partial += decoder.decode(value, { stream: true });
        const lines = partial.split("\n");
        partial = lines.pop() ?? "";

        for (const line of lines) {
          if (!line.trim()) continue;

          try {
            const data: StreamResponse = JSON.parse(line.trim());
            console.log(`data (StreamResponse): ${data}`);
            switch (data.event) {
              case "started":
                console.log(`Started: ${data.payload.message}`);
                const event_time = new Date();
                setResponseInfo((prev) => {
                  const updated = [...prev];
                  updated[index] = {
                    // ã“ã“ã‚’å®Œæˆã•ã›ã‚‹
                  };
                  return updated;
                });

                break;
              case "agent_update":
                console.log(`Agent updated to ${data.payload.agent_name}`);
                break;
              case "code":
                setResponseInfo((prev) => {
                  const updated = [...prev];
                  updated[index] = {
                    // ã“ã“ã‚’å®Œæˆã•ã›ã‚‹
                  };
                  return updated;
                });
                break;
              case "done":
                console.log(`Done: ${data.payload.message}`);
                break;
            }
          } catch (e) {
            console.log("Failed to parse stream line", line, e);
          }
        }
      }
    } catch (error) {
      console.log("Error sending: ", error);
    }
  };

  return (
    <div className="space-y-2 mb-4">
      {(status === "Loaded" || status === "Sended") && (
        <div className="grid grid-cols-6 items-center">
          {/* --- filename row --- */}
          {/* column-A */}
          <div></div>
          {/* column-B */}
          <div className="text-gray-500 text-sm">filename:</div>
          {/* column-C,D,E */}
          <div className="col-span-3 text-sm">{fileInfo.filename}</div>
          {/* column-F */}
          <div className="col-span-1 row-span-2">
            <Button onClick={sendPrompt} disabled={status === "Sended"}>
              <Send className="w-4 h-4 mr-2" />
            </Button>
          </div>
          {/* --- mtime row --- */}
          {/* column-A */}
          <div></div>
          {/* column-B */}
          <div className="text-gray-500 text-sm">mtime:</div>
          {/* column-C,D,E */}
          <div className="col-span-3 text-sm">
            {fileInfo.mtime.toLocaleString()}
          </div>
          {/* column-F */}
          <div></div>
        </div>
      )}
      {status === "Sended" && (
        <div className="grid grid-cols-6 items-center">
          {/* --- avatar row --- */}
          {/* column-A */}
          <div>
            <Avatar>
              <AvatarImage src="/assistant.png" />
              <AvatarFallback>As</AvatarFallback>
            </Avatar>
          </div>
          {/* column-B */}
          <span>Assistant</span>
          {/* column-C,D,E,F */}
          <div className="col-span-4"></div>
          {/* --- rtime row --- */}
          {/* column-A */}
          <div></div>
          {/* column-B */}
          <div className="text-gray-500 text-sm">rtime:</div>
          {/* column-C,D,E */}
          <div className="col-span-3 text-sm">
            {/* ã“ã“ã«ä¸Šè¨˜æ¡ä»¶ã«åŸºã¥ãå‡¦ç†ã‚’è¨˜è¿°ã—ãŸã„ */}
          </div>
          {/* column-F */}
          <div></div>
        </div>
      )}
    </div>
  );
};

export default QA;


[Answer]
ä»¥ä¸‹ã«ã€ã‚ãªãŸã®æŒ‡ç¤ºã«å¾“ã£ã¦ä¿®æ­£ã•ã‚ŒãŸ QA.tsx ã®è©²å½“ç®‡æ‰€ã‚’ç¤ºã—ã¾ã™ã€‚

âœ… ä¿®æ­£æ¡ˆ
1. case "started" ãŠã‚ˆã³ case "code" ã«ã¦ setResponseInfo ã‚’æ­£ã—ãæ›´æ–°

case "started":
  console.log(`Started: ${data.payload.message}`);
  const event_time = new Date();
  setResponseInfo((prev) => {
    const updated = [...prev];
    updated[index] = {
      r_event: [{ s_res: data, r_time: event_time }],
    };
    return updated;
  });
  break;

case "code":
  const code_time = new Date();
  setResponseInfo((prev) => {
    const updated = [...prev];
    const prevEvents = updated[index]?.r_event ?? [];
    updated[index] = {
      r_event: [...prevEvents, { s_res: data, r_time: code_time }],
    };
    return updated;
  });
  break;

2. r_time ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã® JSX ï¼ˆQA.tsx å†…ï¼‰

<div className="col-span-3 text-sm">
  {responseInfo?.r_event?.find((event) => event.s_res.event === "started")?.r_time.toLocaleString() ?? "N/A"}
</div>

ğŸ” è§£èª¬
responseInfo[index] ã¯ ResponseInfo å‹ã§ã€r_event ã« ResponseEvent[] ã‚’æŒã¡ã¾ã™ã€‚

event === "started" ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ .find() ã§å–å¾—ã—ã€ãã® r_time ã‚’ toLocaleString() ã§è¡¨ç¤ºã€‚

"code" ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¥ã¦ã‚‚ r_event ã«è¿½è¨˜ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚

âœ… æœ€çµ‚çš„ãªå®Œæˆå½¢ï¼ˆè©²å½“éƒ¨åˆ†ã®ã¿æŠœç²‹ï¼‰
case "started":

case "started":
  const event_time = new Date();
  setResponseInfo((prev) => {
    const updated = [...prev];
    updated[index] = {
      r_event: [{ s_res: data, r_time: event_time }],
    };
    return updated;
  });
  break;

case "code":

case "code":
  const code_time = new Date();
  setResponseInfo((prev) => {
    const updated = [...prev];
    const prevEvents = updated[index]?.r_event ?? [];
    updated[index] = {
      r_event: [...prevEvents, { s_res: data, r_time: code_time }],
    };
    return updated;
  });
  break;

JSXï¼ˆQA.tsx ã®è©²å½“ JSX éƒ¨åˆ†ï¼‰:

<div className="col-span-3 text-sm">
  {responseInfo?.r_event?.find((event) => event.s_res.event === "started")?.r_time.toLocaleString() ?? "N/A"}
</div>


